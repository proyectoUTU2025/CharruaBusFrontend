<mat-horizontal-stepper [selectedIndex]="step" linear class="stepper">
  <mat-step label="Búsqueda" [completed]="step > 0"></mat-step>
  <mat-step label="Seleccionar viaje" [completed]="step > 1"></mat-step>
  <mat-step label="Pasajero" [completed]="step > 2"></mat-step>
  
  <ng-container *ngIf="tipoViaje === 'IDA'">
    <mat-step label="Asientos" [completed]="step > 3"></mat-step>
    <mat-step label="Resumen" [completed]="step > 4"></mat-step>
  </ng-container>
  
  <ng-container *ngIf="tipoViaje === 'IDA_Y_VUELTA'">
    <mat-step label="Asientos Ida" [completed]="step > 3"></mat-step>
    <mat-step label="Viaje Vuelta" [completed]="step > 4"></mat-step>
    <mat-step label="Asientos Vuelta" [completed]="step > 5"></mat-step>
    <mat-step label="Resumen" [completed]="step > 6"></mat-step>
  </ng-container>
</mat-horizontal-stepper>

<!-- Paso 0: Búsqueda de viajes -->
<mat-card class="compra-card" *ngIf="step === 0">
  <form [formGroup]="searchForm" class="filters">
    <mat-form-field appearance="outline">
      <mat-label>Tipo de Viaje</mat-label>
      <mat-select formControlName="tipoViaje">
        <mat-option value="IDA">Solo Ida</mat-option>
        <mat-option value="IDA_Y_VUELTA">Ida y Vuelta</mat-option>
      </mat-select>
    </mat-form-field>
    
    <mat-form-field appearance="outline">
      <mat-label>Origen</mat-label>
      <mat-select formControlName="localidadOrigenId">
        <mat-option *ngFor="let o of localidades" [value]="o.id">{{ o.nombreConDepartamento }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Destino</mat-label>
      <mat-select formControlName="localidadDestinoId">
        <mat-option *ngFor="let d of destinos" [value]="d.id">{{ d.nombreConDepartamento }}</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Fecha Ida</mat-label>
      <input matInput [matDatepicker]="picker" formControlName="fechaDesde" />
      <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
      <mat-datepicker #picker></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline" *ngIf="tipoViaje === 'IDA_Y_VUELTA'">
      <mat-label>Fecha Vuelta</mat-label>
      <input matInput [matDatepicker]="pickerVuelta" formControlName="fechaVuelta" />
      <mat-datepicker-toggle matSuffix [for]="pickerVuelta"></mat-datepicker-toggle>
      <mat-datepicker #pickerVuelta></mat-datepicker>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Pasajeros</mat-label>
      <mat-select formControlName="pasajeros">
        <mat-option *ngFor="let n of [1,2,3,4,5]" [value]="n">{{ n }}</mat-option>
      </mat-select>
    </mat-form-field>

    <div class="filters-actions">
      <button mat-stroked-button class="outline-btn" (click)="limpiarFiltros()">Limpiar</button>
      <button mat-raised-button class="buscar-btn" (click)="buscar()" [disabled]="searchForm.invalid">Buscar Viajes</button>
    </div>
  </form>
</mat-card>

<!-- Paso 1: Selección de viaje ida -->
<mat-card class="viajes-card" *ngIf="step === 1">
  <div *ngFor="let v of viajes"
       class="viaje-item"
       [class.selected]="v.seleccionado"
       (click)="seleccionarViaje(v, false)">
    <div class="ruta"><strong>{{ v.origen }}</strong> → <strong>{{ v.destino }}</strong></div>
    <div class="horario">
      <mat-icon>schedule</mat-icon>
      {{ v.fechaHoraSalida | date:'shortTime' }} - {{ v.fechaHoraLlegada | date:'shortTime' }}
      · {{ calcularDuracion(v.fechaHoraSalida, v.fechaHoraLlegada) }}
    </div>
    <div class="info">{{ v.asientosDisponibles }} asientos disponibles · ${{ v.precioEstimado }}</div>
  </div>
  <mat-paginator [length]="totalElements" [pageSize]="pageSize" [pageIndex]="pageIndex"
                 [pageSizeOptions]="[5, 10]" (page)="cambiarPagina($event)">
  </mat-paginator>
  <div class="step-actions">
    <button mat-stroked-button class="outline-btn" (click)="anteriorPaso()">Atrás</button>
    <button mat-raised-button class="buscar-btn" (click)="siguientePaso()" [disabled]="!puedeAvanzar()">Siguiente</button>
  </div>
</mat-card>

<!-- Paso 2: Datos del pasajero -->
<mat-card class="viajes-card" *ngIf="step === 2">
  <ng-container *ngIf="authService.rol === 'CLIENTE' && userInfo">
    <h3>Datos del Cliente</h3>
    <div class="datos-cliente">
      <p><strong>Nombre:</strong> {{ userInfo.nombre }} {{ userInfo.apellido }}</p>
      <p><strong>Email:</strong> {{ userInfo.email }}</p>
      <p><strong>Documento:</strong> {{ userInfo.documento }}</p>
    </div>
  </ng-container>
  <ng-container *ngIf="authService.rol === 'VENDEDOR'">
    <h3>Buscar Cliente</h3>
    <mat-form-field appearance="outline" class="autocomplete-field">
      <mat-label>Buscar cliente</mat-label>
      <input type="text" matInput [(ngModel)]="searchTerm" (input)="buscarClientes()" [matAutocomplete]="auto" autocomplete="off" />
    </mat-form-field>
    <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayCliente" (optionSelected)="seleccionarCliente($event.option.value)">
      <mat-option *ngFor="let c of clientesFiltrados" [value]="c">
        <div class="autocomplete-option">
          <mat-icon>person</mat-icon>
          {{ c.nombre }} {{ c.apellido }} ({{ c.documento }})
        </div>
      </mat-option>
    </mat-autocomplete>
    <mat-card class="ficha-cliente" *ngIf="userInfo">
      <mat-card-title>{{ userInfo.nombre }} {{ userInfo.apellido }}</mat-card-title>
      <mat-card-content>
        <p><strong>Email:</strong> {{ userInfo.email }}</p>
        <p><strong>Documento:</strong> {{ userInfo.documento }}</p>
        <p><strong>Tipo:</strong> {{ userInfo.tipoDocumento }}</p>
        <p><strong>Categoría:</strong> {{ userInfo.situacionLaboral || 'No especificada' }}</p>
      </mat-card-content>
    </mat-card>
  </ng-container>
  <div class="step-actions">
    <button mat-stroked-button class="outline-btn" (click)="anteriorPaso()">Atrás</button>
    <button mat-raised-button class="buscar-btn" (click)="siguientePaso()" [disabled]="!puedeAvanzar()">Siguiente</button>
  </div>
</mat-card>

<!-- Paso 3: Selección de asientos ida -->
<mat-card class="viajes-card seat-selection-card" *ngIf="step === 3 && viajeIdaSeleccionado">
  <div class="loading-overlay" *ngIf="isLoadingNextStep">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando siguiente paso...</p>
  </div>
  
  <div class="selection-header">
    <div class="selection-summary">
      <h4>Asientos de Ida Seleccionados</h4>
      <mat-chip-listbox *ngIf="selectedSeats.length > 0">
        <mat-chip *ngFor="let seat of selectedSeats">Asiento {{seat}}</mat-chip>
      </mat-chip-listbox>
      <p *ngIf="selectedSeats.length === 0">Selecciona hasta {{searchForm.value.pasajeros}} asientos.</p>
    </div>
    <div class="price-summary">
      <p>Precio por pasaje: <strong>{{ viajeIdaSeleccionado.precioEstimado | currency }}</strong></p>
      <p class="total-price">Total: <strong>{{ (selectedSeats.length * viajeIdaSeleccionado.precioEstimado) | currency }}</strong></p>
    </div>
  </div>
  
  <app-seats 
    [totalAsientos]="viajeIdaSeleccionado.asientosDisponibles + (asientosOcupadosIda?.length || 0)"
    [asientosOcupados]="asientosOcupadosIda"
    [asientosSeleccionados]="selectedSeats"
    [maxSeleccion]="searchForm.value.pasajeros"
    (seleccionCambio)="onAsientosIdaChange($event)">
  </app-seats>
  
  <div class="step-actions">
    <button mat-stroked-button class="outline-btn" (click)="anteriorPaso()">Atrás</button>
    <button mat-raised-button class="buscar-btn" (click)="siguientePaso()" [disabled]="!puedeAvanzar()">Siguiente</button>
  </div>
</mat-card>

<!-- Paso 4: Selección viaje vuelta (si aplica) o Resumen (si es solo ida) -->
<ng-container *ngIf="tipoViaje === 'IDA_Y_VUELTA' && step === 4">
  <mat-card class="viajes-card">
    <h3>Seleccione viaje de vuelta</h3>
    <div *ngFor="let v of viajesVuelta"
         class="viaje-item"
         [class.selected]="v.seleccionado"
         (click)="seleccionarViaje(v, true)">
      <div class="ruta"><strong>{{ v.origen }}</strong> → <strong>{{ v.destino }}</strong></div>
      <div class="horario">
        <mat-icon>schedule</mat-icon>
        {{ v.fechaHoraSalida | date:'shortTime' }} - {{ v.fechaHoraLlegada | date:'shortTime' }}
        · {{ calcularDuracion(v.fechaHoraSalida, v.fechaHoraLlegada) }}
      </div>
      <div class="info">{{ v.asientosDisponibles }} asientos disponibles · ${{ v.precioEstimado }}</div>
    </div>
    <div class="step-actions">
      <button mat-stroked-button class="outline-btn" (click)="anteriorPaso()">Atrás</button>
      <button mat-raised-button class="buscar-btn" (click)="siguientePaso()" [disabled]="!puedeAvanzar()">Siguiente</button>
    </div>
  </mat-card>
</ng-container>

<ng-container *ngIf="tipoViaje === 'IDA' && step === 4">
  <mat-card class="viajes-card resumen-card">
    <h3>Resumen de la Compra</h3>
    
    <div class="info-section" *ngIf="userInfo">
      <h4>Información del Cliente</h4>
      <p><strong>Nombre:</strong> {{ userInfo.nombre }} {{ userInfo.apellido }}</p>
      <p><strong>Email:</strong> {{ userInfo.email }}</p>
      <p><strong>Documento:</strong> {{ userInfo.documento }}</p>
    </div>
    <mat-divider></mat-divider>
    
    <div class="info-section" *ngIf="viajeIdaSeleccionado">
      <h4>Viaje de Ida</h4>
      <p><strong>Ruta:</strong> {{ viajeIdaSeleccionado.origen }} → {{ viajeIdaSeleccionado.destino }}</p>
      <p><strong>Fecha:</strong> {{ viajeIdaSeleccionado.fechaHoraSalida | date:'dd/MM/yyyy' }}</p>
      <p><strong>Horario:</strong> {{ viajeIdaSeleccionado.fechaHoraSalida | date:'shortTime' }} - {{ viajeIdaSeleccionado.fechaHoraLlegada | date:'shortTime' }}</p>
    </div>
    <mat-divider></mat-divider>
    
    <div class="info-section">
      <h4>Asientos Seleccionados</h4>
      <p><strong>Cantidad:</strong> {{ selectedSeats.length }}</p>
      <p><strong>Asientos:</strong> {{ selectedSeats.join(', ') }}</p>
    </div>
    <mat-divider></mat-divider>

    <div class="info-pago">
      <h4>Detalle del Pago</h4>
      <p><strong>Precio por pasaje:</strong> ${{ viajeIdaSeleccionado?.precioEstimado | number:'1.2-2' }}</p>
      <p class="total"><strong>Total:</strong> ${{ (selectedSeats.length * (viajeIdaSeleccionado?.precioEstimado || 0)) | number:'1.2-2' }}</p>
    </div>
    
    <div class="step-actions">
      <button mat-stroked-button class="outline-btn" (click)="anteriorPaso()">Atrás</button>
      <button mat-raised-button class="buscar-btn" (click)="confirmarCompra()" [disabled]="!puedeConfirmar()">Proceder al Pago</button>
    </div>
  </mat-card>
</ng-container>

<!-- Paso 5: Selección de asientos vuelta (si aplica) -->
<mat-card class="viajes-card seat-selection-card" *ngIf="tipoViaje === 'IDA_Y_VUELTA' && step === 5 && viajeVueltaSeleccionado">
  <div class="loading-overlay" *ngIf="isLoadingNextStep">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Cargando siguiente paso...</p>
  </div>
  
  <div class="selection-header">
    <div class="selection-summary">
      <h4>Asientos de Vuelta Seleccionados</h4>
      <mat-chip-listbox *ngIf="selectedSeatsVuelta.length > 0">
        <mat-chip *ngFor="let seat of selectedSeatsVuelta">Asiento {{seat}}</mat-chip>
      </mat-chip-listbox>
      <p *ngIf="selectedSeatsVuelta.length === 0">Selecciona hasta {{searchForm.value.pasajeros}} asientos.</p>
    </div>
    <div class="price-summary">
      <p>Precio por pasaje: <strong>{{ viajeVueltaSeleccionado.precioEstimado | currency }}</strong></p>
      <p class="total-price">Total: <strong>{{ (selectedSeatsVuelta.length * viajeVueltaSeleccionado.precioEstimado) | currency }}</strong></p>
    </div>
  </div>

  <app-seats 
    [totalAsientos]="viajeVueltaSeleccionado.asientosDisponibles + (asientosOcupadosVuelta?.length || 0)"
    [asientosOcupados]="asientosOcupadosVuelta"
    [asientosSeleccionados]="selectedSeatsVuelta"
    [maxSeleccion]="searchForm.value.pasajeros"
    (seleccionCambio)="onAsientosVueltaChange($event)">
  </app-seats>
  
  <div class="step-actions">
    <button mat-stroked-button class="outline-btn" (click)="anteriorPaso()">Atrás</button>
    <button mat-raised-button class="buscar-btn" (click)="siguientePaso()" [disabled]="!puedeAvanzar()">Siguiente</button>
  </div>
</mat-card>

<!-- Paso 6: Resumen (si es ida y vuelta) -->
<mat-card class="viajes-card" *ngIf="tipoViaje === 'IDA_Y_VUELTA' && step === 6">
  <div class="info-cliente" *ngIf="userInfo">
    <h4>Información del Cliente</h4>
    <p><strong>Nombre:</strong> {{ userInfo.nombre }} {{ userInfo.apellido }}</p>
    <p><strong>Email:</strong> {{ userInfo.email }}</p>
    <p><strong>Documento:</strong> {{ userInfo.documento }}</p>
    <p><strong>Tipo:</strong> {{ userInfo.rol }}</p>
  </div>
  <div class="info-asientos">
    <h4>Asientos Ida</h4>
    <ul>
      <li *ngFor="let asiento of selectedSeats">Asiento {{ asiento }}</li>
    </ul>
    <h4>Asientos Vuelta</h4>
    <ul>
      <li *ngFor="let asiento of selectedSeatsVuelta">Asiento {{ asiento }}</li>
    </ul>
  </div>
  <div class="info-pago">
    <h4>Detalle del Pago</h4>
    <p><strong>Ruta Ida:</strong> {{ viajeIdaSeleccionado?.origen }} → {{ viajeIdaSeleccionado?.destino }}</p>
    <p><strong>Pasaje Ida:</strong> ${{ viajeIdaSeleccionado?.precioEstimado }}</p>
    <p><strong>Ruta Vuelta:</strong> {{ viajeVueltaSeleccionado?.origen }} → {{ viajeVueltaSeleccionado?.destino }}</p>
    <p><strong>Pasaje Vuelta:</strong> ${{ viajeVueltaSeleccionado?.precioEstimado }}</p>
    <p><strong>Total:</strong> ${{ (selectedSeats.length * (viajeIdaSeleccionado?.precioEstimado || 0)) + (selectedSeatsVuelta.length * (viajeVueltaSeleccionado?.precioEstimado || 0)) }}</p>
  </div>
  <div class="step-actions">
    <button mat-stroked-button class="outline-btn" (click)="anteriorPaso()">Atrás</button>
    <button mat-raised-button class="buscar-btn" (click)="confirmarCompra()" [disabled]="!puedeConfirmar()">Proceder al Pago</button>
  </div>
</mat-card>

<!-- Paso final: Estado de la compra -->
<mat-card class="compra-card" *ngIf="estadoCompra">
  <div *ngIf="estadoCompra === 'exito'" class="compra-estado exito">
    <mat-icon>check_circle</mat-icon>
    <h2>¡Compra Exitosa!</h2>
    <p>Tu compra se ha realizado correctamente. Revisa tu correo para ver los detalles.</p>
  </div>
  <div *ngIf="estadoCompra === 'cancelado' || estadoCompra === 'error'" class="compra-estado error">
    <mat-icon>cancel</mat-icon>
    <h2>La compra ha sido cancelada</h2>
    <p>La compra fue cancelada o ha ocurrido un error. Por favor, inténtalo de nuevo.</p>
  </div>
  <div class="step-actions">
    <button mat-raised-button class="buscar-btn" routerLink="/home">Volver al Inicio</button>
  </div>
</mat-card>