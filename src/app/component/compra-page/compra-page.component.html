<mat-horizontal-stepper [selectedIndex]="step" linear>
  <mat-step label="BÃºsqueda"></mat-step>
  <mat-step label="Seleccionar viaje"></mat-step>
  <mat-step label="Pasajeros"></mat-step>
  <ng-container *ngIf="tipoViaje === 'IDA'">
    <mat-step label="Resumen"></mat-step>
  </ng-container>
  <ng-container *ngIf="tipoViaje === 'IDA_Y_VUELTA'">
    <mat-step label="Viaje vuelta"></mat-step>
    <mat-step label="Asientos vuelta"></mat-step>
    <mat-step label="Resumen"></mat-step>
  </ng-container>
</mat-horizontal-stepper>

<mat-tab-group [selectedIndex]="tipoViaje==='IDA'?0:1" (selectedIndexChange)="cambiarTipoViaje($event)">
  <mat-tab label="Ida"></mat-tab>
  <mat-tab label="Ida y Vuelta"></mat-tab>
</mat-tab-group>

<mat-card *ngIf="step===0">
  <form [formGroup]="searchForm">
    <div class="form-row">
      <mat-form-field appearance="fill">
        <mat-label>Origen</mat-label>
        <mat-select formControlName="localidadOrigenId">
          <mat-option *ngFor="let o of localidades" [value]="o.id">{{ o.nombre }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Destino</mat-label>
        <mat-select formControlName="localidadDestinoId">
          <mat-option *ngFor="let d of destinos" [value]="d.id">{{ d.nombre }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
    <div class="form-row">
      <mat-form-field appearance="fill">
        <mat-label>Fecha Ida</mat-label>
        <input matInput [matDatepicker]="picker1" formControlName="fechaDesde">
        <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
        <mat-datepicker #picker1></mat-datepicker>
      </mat-form-field>
      <mat-form-field *ngIf="tipoViaje==='IDA_Y_VUELTA'" appearance="fill">
        <mat-label>Fecha Vuelta</mat-label>
        <input matInput [matDatepicker]="picker2" formControlName="fechaVuelta">
        <mat-datepicker-toggle matSuffix [for]="picker2"></mat-datepicker-toggle>
        <mat-datepicker #picker2></mat-datepicker>
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Pasajeros</mat-label>
        <input matInput type="number" formControlName="pasajeros">
      </mat-form-field>
    </div>
    <div class="actions">
      <button mat-raised-button color="primary" (click)="buscar()" [disabled]="searchForm.invalid">
        Buscar
      </button>
    </div>
  </form>
</mat-card>

<mat-card *ngIf="step===1">
  <table mat-table [dataSource]="dataSource">
    <ng-container matColumnDef="origen">
      <th mat-header-cell *matHeaderCellDef>Origen</th>
      <td mat-cell *matCellDef="let v">{{ v.origen }}</td>
    </ng-container>
    <ng-container matColumnDef="destino">
      <th mat-header-cell *matHeaderCellDef>Destino</th>
      <td mat-cell *matCellDef="let v">{{ v.destino }}</td>
    </ng-container>
    <ng-container matColumnDef="precio">
      <th mat-header-cell *matHeaderCellDef>Precio</th>
      <td mat-cell *matCellDef="let v">{{ v.precioEstimado }}</td>
    </ng-container>
    <ng-container matColumnDef="seleccionar">
      <th mat-header-cell *matHeaderCellDef></th>
      <td mat-cell *matCellDef="let v">
        <button mat-button (click)="seleccionarViaje(v)">Seleccionar</button>
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
  </table>

  <mat-paginator [length]="totalElements" [pageSize]="pageSize" (page)="pageChanged($event)">
  </mat-paginator>
</mat-card>

<mat-card *ngIf="step===2">
  <button mat-stroked-button (click)="abrirDialogPasajeros()">
    Seleccionar Asientos
  </button>
  <div class="info">
    Asientos seleccionados: {{ selectedSeats.join(', ') || 'Ninguno' }}
  </div>
</mat-card>

<app-purchase-summary-dialog *ngIf="step===3 && tipoViaje==='IDA'"
  [data]="{ seats: selectedSeats, total: selectedSeats.length * (viajeIdaSeleccionado?.precioEstimado || 0) }"
  (confirm)="confirmarCompra()" (cancel)="step=2">
</app-purchase-summary-dialog>

<mat-card *ngIf="step===4">
  <p>Redirigiendo a pasarela de pago...</p>
</mat-card>

<mat-card *ngIf="step===5">
  <p *ngIf="estadoCompra==='exito'">Compra exitosa.</p>
  <p *ngIf="estadoCompra==='cancelado'">Compra cancelada.</p>
  <p *ngIf="estadoCompra==='error'">Error en la compra.</p>
</mat-card>

<div class="step-controls">
  <button mat-flat-button (click)="anteriorPaso()" [disabled]="step===0">
    Anterior
  </button>
  <button mat-flat-button color="primary" (click)="siguientePaso()" [disabled]="step === (tipoViaje==='IDA'?3:4)">
    Siguiente
  </button>
</div>